<!--- Last updated: Sunday, May 3 at 9:50 PM -->

<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Let's Go Team</title>

  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>


    <!-- Main Javascript -->
    <script src="js/main.js"></script>

    <!-- Search Functions -->
    <script src="js/search.js"></script>

    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- An attempt ot make the sidebar work -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="FPScripts.js"></script>

    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>

    <!-- Sidebar -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <link href="css/simple-sidebar-right.css" rel="stylesheet">

    <!--Autosuggest jQuery-->
    <script src="libs/jquery-ui/jquery.js"></script>
    <script src="libs/jquery-ui/jquery-ui.js"></script>
    <link rel="stylesheet" href="libs/jquery-ui/jquery-ui.css">

    <style type="text/css">
    body {
      width: 1400px;
      margin: 25px auto;
      font-family: 'Lato', sans-serif;
      text-align: center;
    }
    .node {
      stroke: #999;
      stroke-width: 1;
      fill: #33B5E5;
      opacity: 0.9;
    }
    .zero {
      fill: #33B5E5;
    }
    .one{
      fill: #ff4500; 
    }
    .two{
      fill: #98df8a;
    }
    .three{
      fill: #FFBB33;
    }
    .four{
      fill: #FF4444;
    }
      circle:hover {
          opacity: 0.3;
        }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    .info {
      line-height: 12px;
    }
    #clicked {
      font-size: 14pt;
    }
    .header {
      font-size: 18pt;
    }
    #primary {
      color: #33B5E5;
    }
    .playing {
      color: #FF4444;
    }
    .search{
      font-size: 16pt;
      text-align: center;
    }
    .ui-menu-item{
      font-family: 'Lato', sans-serif;
    }
    .btn:hover{
      background-color: #d3d3d3;
    }
    .ui-menu{
      width: 241px;
    }
  </style>

  <script>

  </script>
</head>

<body>

  <div id="wrapper">
  <!-- Sidebar -->
        <div id="sidebar-wrapper" style="text-align: center">

            <!-- Navigation for the sidebar -->
            <div class="info">
              <ul class="sidebar-nav">
                  <li>
                      <text id="clicked" style="font-size: 27px">Artist</text>
                  </li>
                  <li>
                      <a class="song" id="song1" onclick="playSong(0)" style="cursor: pointer">Artist Song 1</a>
                  </li>
                  <li>
                      <a class="song" id="song2" onclick="playSong(1)" style="cursor: pointer">Artist Song 2</a>
                  </li>
                  <li>
                      <a class="song" id="song3" onclick="playSong(2)" style="cursor: pointer">Artist Song 3</a>
                  </li>
                  <li>
                      <a class="song" id="song4" onclick="playSong(3)" style="cursor: pointer">Artist Song 4</a>
                  </li>
                  <li>
                      <a class="song" id="song5" onclick="playSong(4)" style="cursor: pointer">Artist Song 5</a>
                  </li>
                  <li>
                      <a class="song" id="song6" onclick="playSong(5)" style="cursor: pointer">Artist Song 6</a>
                  </li>
                  <li>
                      <a class="song" id="song7" onclick="playSong(6)" style="cursor: pointer">Artist Song 7</a>
                  </li>
                  <li>
                      <a class="song" id="song8" onclick="playSong(7)" style="cursor: pointer">Artist Song 8</a>
                  </li>
                  <li>
                      <a class="song" id="song9" onclick="playSong(8)" style="cursor: pointer">Artist Song 9</a>
                  </li>
                  <li>
                      <a class="song" id="song10" onclick="playSong(9)" style="cursor: pointer">Artist Song 10</a>
                  </li>
                  <br> <br>

                  <span style="font-size: 20px"> PROJECT TEAM </span>
                  <br><br>
                  <li>
                      <a href="https://www.facebook.com/amhrla" target="_blank">Angela Jiang '17</a>
                  </li>
                  <li>
                      <a href="https://www.facebook.com/jason.shen.16" target="_blank">Jason Shen '17</a>
                  </li>
                  <li>
                      <a href="https://www.facebook.com/kit.wu.12" target="_blank">Kit Wu '17</a>
                  </li>
              </ul>
            </div>  
        </div>
        <!-- /#sidebar-wrapper -->
      </div>

        <!-- Sidebar -->
      <div id="wrapper-right">
        <div id="sidebar-wrapper-right" style="text-align: center">
            <div>
              <ul class="sidebar-nav">
                  <li class="sidebar-brand">
                      <strong>USER CONTROL PANEL</strong>
                  </li>
              </ul>
            </div>

            <!-- Navigation for the sidebar -->
            <div>
              <ul class="sidebar-nav">
                  <div>
                      <input id="searchbar" class="search" placeholder="Search for an Artist" onkeyup="search()">
                      <button type="button" id="searchbutton" class="btn btn-default" onclick="goSearch()">GO</button>
                  </div>
                  <br>
                  <span style="font-size: 20px"> NODE TOGGLES </span>
                  <br>
                  Here, you can manipulate the properties surrounding the nodes.
                  <li>
                      <strong> Number of Nodes Around Central Node </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNumNodes(1)">1</button>
                        <button class="btn" onclick="changeNumNodes(2)">2</button>
                        <button class="btn" onclick="changeNumNodes(3)">3</button>
                        <button class="btn" onclick="changeNumNodes(4)">4</button>
                        <button class="btn" onclick="changeNumNodes(5)">5</button>
                      </div>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNumNodes(6)">6</button>
                        <button class="btn" onclick="changeNumNodes(7)">7</button>
                        <button class="btn" onclick="changeNumNodes(8)">8</button>
                        <button class="btn" onclick="changeNumNodes(9)">9</button>
                        <button class="btn" onclick="changeNumNodes(10)">10</button>
                      </div>
                  </li>
                  <li>
                      <strong> Degree of Nodes </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeDegreeNodes(1)">1</button>
                        <button class="btn" onclick="changeDegreeNodes(2)">2</button>
                        <button class="btn" onclick="changeDegreeNodes(3)">3</button>
                        <button class="btn" onclick="changeDegreeNodes(4)">4</button>
                        <button class="btn" onclick="changeDegreeNodes(5)">5</button>
                      </div>
                  </li>
                  <li>
                      <strong> Size of Nodes </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNodeSize(1)">Small</button>
                        <button class="btn" onclick="changeNodeSize(17)">Medium</button>
                        <button class="btn" onclick="changeNodeSize(30)">Large</button>
                      </div>
                  </li>
                  <li>
                      <strong> Freeze visualization? (It helps with lag)</strong> 
                      <div class="btn-group">
                        <button class="btn" onclick="stopForceLayout()">Yes</button>
                        <button class="btn" onclick="restartForceLayout()">Unfreeze</button>
                      </div>
                  </li>
                  <li>
                      <strong> Charge (Space between nodes)</strong> 
                      <div class="btn-group">
                        <button class="btn" onclick="changeCharge(-1000)">Low</button>
                        <button class="btn" onclick="changeCharge(-5000)">Normal</button>
                        <button class="btn" onclick="changeCharge(-10000)">High</button>
                        <button class="btn" onclick="changeCharge(-50000)">Super</button>
                      </div>
                      <br>
                  </li>
                  <br>
              </ul>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->
      </div>

        <div class="header">
          <span style="font-size: 30px">7 degrees of <text id="primary">Spotify</text></span> <br>
          <span style="font-size: 20px">Currently hovering on: <text id="hovered"></text></span> <br>
          <button type="button" class="btn btn-default" onclick="stopMusic()">Stop Music</button>
          <a class="btn btn-default" id="menu-toggle">Toggle Left</a>
          <a class="btn btn-default" id="menu-toggle-right">Toggle Right</a>
        </div>

  <script>
  var degree; // degree of separation where 0 is the original artist
  var limit = 1; // highest degree from main artist; max 5
  var frontier = [[],[]]; // keeping what needs to be visited (IDs)
  var visited = []; // keeping what has already been visited (IDs)
  var graph = {nodes: [], links: []};
  var starting_id = "04gDigrS5kc9YWfZHwBETP";
  var num_related = 10; // number [1,20]
  var baseUrl = "https://api.spotify.com/v1/artists/";
  var searchUrl = "https://api.spotify.com/v1/search?q=";
  var audio = new Audio();
  var curr_id = null;
  var deg_names = ["zero","one","two","three","four","five"];
  var nodeSize = 17;
  var currentNodeID = starting_id;
  var doubleClicked = false;
  var forceCharge = -5000;
  var currTracks = [];
  var click_id = null;
  var click = 0;
  var order = [];
  var primaryObj = {};
  var samePrimary = false;

  // Dimensions for SVG
  var margin = {top: 40, bottom: 10, left: 20, right: 20};
  var width = 1400 - margin.left - margin.right;
  var height = 600 - margin.top - margin.bottom;

  var force = d3.layout.force()
        .charge(forceCharge)
        .friction(0.9)
        .size([width, height])
        .gravity(2.0);

  // Creates sources <svg> element and inner g (for margins)
  var svg = d3.select("body").append("svg")
            .attr("width", width+margin.left+margin.right)
            .attr("height", height+margin.top+margin.bottom)

  // first run: grabbing THE artist
  var start = function (id) {
    queue()
        .defer(d3.json, "https://api.spotify.com/v1/artists/" + id) 
        .await(function(error, data) {
          data.degree = 0;
          graph.nodes.push(data);
          frontier[0].push(id);
          visited.push(id);
          degree = 0;
          primaryObj = data;

          get_related ();
        });
  }

  var get_related = function () {
    if (degree < limit) {
      var q = queue();
      
      frontier[0].forEach(function (id) {
          q.defer(d3.json, "https://api.spotify.com/v1/artists/" + id + "/related-artists")
      }) // load all artists that need to be visited

      // does not run until all artists in frontier[0] have been loaded
      q.awaitAll(function (error, obj_array) { 
            
            if (error) return console.warn(error);

            obj_array.forEach(function (artist,i) {

              for (var j = 0; j < num_related; j++)
              {
                var rel_artist = artist.artists[j];

                if ( $.inArray(rel_artist.id, visited) < 0 ) {
                  rel_artist.degree = degree + 1;
                  graph.nodes.push(rel_artist); // add to nodes
                  frontier[1].push(rel_artist.id); // add to frontier
                  visited.push(rel_artist.id); // add to visited
                }

                getLinks(frontier[0][i],rel_artist.id);
                
              }
                
            }) // end obj_array forEach

            frontier.shift(); // truncates frontiers such that frontiers[1] = frontiers[0]
            frontier.push([]); // pushes empty array to end of frontier
            degree = degree + 1;
            get_related ();

        }) // end awaitall

    } // end if (degree < limit)

    if (degree == limit){
      d3.select(".header").select("#primary")
          .text(graph.nodes[0].name);
       
       render();
    }      
    } // end get_related

    // creates nodes and links
    var render = function () {
        var link = svg.selectAll(".link")
            .data(graph.links);

        link
          .enter().append("line");

        link
           .attr("class", "link");

        link
          .exit()
          .remove();

        var artist = svg.selectAll(".artist")
          .data(graph.nodes);

        var artist_enter = artist.enter()
                              .append("g")
                              .append("circle")

        var artist_names = artist
                        .append("text")
                        .attr("font-size", 14)
                        .text(function(d) { if (d.degree < 3) { return d.name} })

        artist
          .attr("class",function(d) {return "artist " + d.name})
        
        artist.select("circle")
          .attr("class", function (d) {return "node " + deg_names[d.degree]})
          .attr("id", function(d) {return d.name})
          .attr("r", function(d) {return nodeSize/(d.degree + 0.35)})

          artist
            .exit()
            .remove();

        var node = svg.selectAll(".node")
        .call(force.drag);

        force
        .nodes(graph.nodes)
        .links(graph.links)
        .start();

      force.on("tick", function(e) {
        link
        // .transition().duration(150)
        .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

          node
          // .transition().duration(150)
          .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

          svg.selectAll("text")
            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; }); 
      })

      if (!samePrimary) {
        queue()
          .defer(d3.json, baseUrl + primaryObj.id + "/top-tracks?country=US") 
          .await(function(error, d) {
            playRandom(primaryObj,d);
        })
      }

      // hover
      d3.selectAll(".node").on("mouseover", function (obj) {
        var info = d3.select(".info")
        d3.select(".header").select("#hovered")
          .text(obj.name.toUpperCase());
        info.select("#degree")
          .text(obj.degree);
      })

      d3.selectAll(".node").on("mouseout", function (obj) {
        var info = d3.select(".info");
        d3.select(".header").select("#hovered")
            .text("NONE");
        info.select("#degree")
            .text("None");
      })

      // click
      d3.selectAll(".node").on("click", function (obj) {
        samePrimary = true;
        var wait_30sec = null;
          clearTimeout(wait_30sec);

          queue()
            .defer(d3.json, baseUrl + obj.id + "/top-tracks?country=US") 
            .await(function(error, d) {
              playRandom(obj,d);
          })
      });

      // double click
      d3.selectAll(".node").on("dblclick", function (obj) {
        samePrimary = false;
        doubleClicked = true;
        currentNodeID = obj.id;
        refresh(obj.id);
      })

    }


/*************************************************************

  HELPER FUNCTIONS GO BELOW HERE...

  ***********************************************************/

  // function pushes the corresponding link into graph.links
  var getLinks = function (sourceID, targetID) {

    // variable to store index in graph.nodes of the artist we only have the ID for
    var sourceIndex;
    var targetIndex;

    for (var j = graph.nodes.length - 1; j >= 0; j--) {
            if (graph.nodes[j].id == sourceID)
              sourceIndex = j;
            if (graph.nodes[j].id == targetID)
              targetIndex = j;
    };
    
    graph.links.push({source: sourceIndex, target: targetIndex});
  }

  // function that populates songs
  var getSongs = function (tracks) {
    var len = tracks.length;
    tracks.forEach(function(track,i){
      d3.select(".info").select("#song" + (i+1))
        .text(track.name);

      for (var i = len; i < 10; i++) {
        d3.select(".info").select("#song" + (i+1))
          .text("");
      }
    })
  }

  // shuffles order
  var shuffle = function (num) {
    var array = [];
    console.log(num)
    for (var i = 0; i < num; i++)
      array[i] = i;

    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }

    return array;
  }

  // stops music
  var stopMusic = function() {
    d3.select(".info").selectAll(".song")
      .classed("playing",false);
    audio.pause();
    audio.currentTime = 0;
    curr_id = null;
  }

  // play song
  var playSong = function(num) {
    d3.select(".info").selectAll(".song")
      .classed("playing",false);
    d3.select(".info").select("#song" + (num+1))
      .classed("playing",true);

    var track = currTracks[num];
    audio.src = track.preview_url;

    // after 30 second preview, unhighlight
    wait_30sec = setTimeout(function (){
      d3.select(".info").select("#song" + (num+1))
      .classed("playing",false);
      }, 30500);

    audio.play();
  }

  var playRandom = function(obj,d) {
    d3.select(".info").selectAll(".song")
            .classed("playing",false);

    d3.select(".info").select("#clicked")
      .text(obj.name);

    if (click_id != obj.id) {
      click = 0;
      click_id = obj.id;

      currTracks = d.tracks;
      getSongs(currTracks);
      order = shuffle(currTracks.length);
    }

    if (currTracks.length == 1)
      var track_num = 0;
    else {
      var track_num = order[click % (currTracks.length - 1)];
      console.log(order);
    }


    var track = currTracks[track_num];
    d3.select(".info").select("#song" + (track_num+1))
      .classed("playing",true);
    audio.src = track.preview_url;

    // after 30 second preview, unhighlight
    wait_30sec = setTimeout(function (){
      d3.select(".info").select("#song" + (track_num+1))
      .classed("playing",false);
      }, 30500);

    audio.play();

    click += 1;
  }

  var refresh = function (id) {
    graph = {nodes: [], links: []};
    frontier = [[],[]]; // keeping what needs to be visited (IDs)
    visited = [];
    svg.selectAll("text").remove();
    start(id);
  }


  var changeNumNodes = function(number) {
    num_related = number;
    samePrimary = true;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  // Note to self: the degree that I'm thinking of is actually limit
  var changeDegreeNodes = function(newDegree) {
    limit = newDegree;
    samePrimary = true;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  var changeNodeSize = function(sizeOfNode) {
    nodeSize = sizeOfNode;
    samePrimary = true;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  var stopForceLayout = function() {
    force.stop();
  }

  var restartForceLayout = function() {
    force.start();
  }

  var changeCharge = function(newCharge) {
    forceCharge = newCharge;
    samePrimary = true;

    force = d3.layout.force()
        .charge(forceCharge)
        .friction(0.9)
        .size([width, height])
        .gravity(1.5);

    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  if (window.location.hash) {
    startSearchHash();
  }
  else {
    start (starting_id);
  }

  </script>

  <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

      $(function() {
    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({
            scrollTop: target.offset().top
          }, 1000);
          return false;
        }
      }
    });
  });

    </script>

    <!-- Right Sidebar -->
    <script>
    $("#menu-toggle-right").click(function(e) {
        e.preventDefault();
        $("#wrapper-right").toggleClass("toggled");
    });

      $(function() {
    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({
            scrollTop: target.offset().top
          }, 1000);
          return false;
        }
      }
    });
  });

    </script>

</body>

</html>