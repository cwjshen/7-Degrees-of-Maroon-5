<!--- Last updated: Sunday, May 3 at 9:50 PM -->

<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Artist Exploration</title>

    <!--jQuery-->
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script> 

    <!-- D3 -->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script> 

    <!-- Bootstrap -->
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Main -->
    <script src="js/main.js"></script>
    <link rel="stylesheet" href="css/main.css">

    <!-- Search Functions -->
    <script src="js/search.js"></script>

    <!-- An attempt ot make the sidebar work -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>

    <!-- Sidebar -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <link href="css/simple-sidebar-right.css" rel="stylesheet">

    <!-- Autocomplete jQuery-UI -->
    <script src="libs/jquery-ui/jquery.js"></script>
    <script src="libs/jquery-ui/jquery-ui.js"></script>
    <link rel="stylesheet" href="libs/jquery-ui/jquery-ui.css">

    <style type="text/css">
    .selected{
      background-color: #9fe025;
    }
    .ui-menu-item{
      font-family: 'Lato', sans-serif;
    }
    .ui-menu{
      width: 241px;
    }
    li a {
      color: black;
    }
  </style>

    <!-- Helper Functions -->
    <script src="js/helper.js"></script>
   
</head>

<body>

  <div id="wrapper">
  <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <!-- Navigation for the sidebar -->
            <div class="info">
              <ul class="sidebar-nav">
                  <li>
                      <text id="clicked"></text>
                  </li>
                  <hr style="margin-top: 0px; margin-bottom: 0px;">
                  <li>
                      <a class="song" id="song1" onclick="playSong(0)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song2" onclick="playSong(1)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song3" onclick="playSong(2)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song4" onclick="playSong(3)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song5" onclick="playSong(4)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song6" onclick="playSong(5)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song7" onclick="playSong(6)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song8" onclick="playSong(7)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song9" onclick="playSong(8)" style="cursor: pointer"></a>
                  </li>
                  <li>
                      <a class="song" id="song10" onclick="playSong(9)" style="cursor: pointer"></a>
                  </li>
                  <br> <br><br>

                  <span style="font-size: 20px"> PROJECT TEAM </span>
                  <br><br>
                  <li>
                      <a href="https://www.facebook.com/amhrla" target="_blank">Angela Jiang '17</a>
                  </li>
                  <li>
                      <a href="https://www.facebook.com/jason.shen.16" target="_blank">Jason Shen '17</a>
                  </li>
                  <li>
                      <a href="https://www.facebook.com/kit.wu.12" target="_blank">Kit Wu '17</a>
                  </li>
                  <li>
                      <a href="https://www.youtube.com/watch?v=q-MTfIop2Hk" target="_blank">Video</a>
                  </li>
                  <li>
                      <a href="CS171 - Process Book.pdf" target="_blank">Process Book</a>
                  </li>
              </ul>
            </div>  
        </div>
        <!-- /#sidebar-wrapper -->
      </div>

        <!-- Sidebar -->
      <div id="wrapper-right">
        <div id="sidebar-wrapper-right" style="text-align: center">
            <div>
              <ul class="sidebar-nav">
                  <li class="sidebar-brand">
                      <strong>USER CONTROL PANEL</strong>
                  </li>
              </ul>
            </div>

            <!-- Navigation for the sidebar -->
            <div>
              <ul class="sidebar-nav">
                  <div>
                      <input id="searchbar" class="search" placeholder="Search for an Artist" onkeyup="search()">
                      <button type="button" id="searchbutton" class="btn btn-default" onclick="goSearch()">GO</button>
                  </div>
                  <br>
                  <span style="font-size: 20px"> NODE TOGGLES </span>
                  <br>
                  Here, you can manipulate the properties surrounding the nodes.
                  <li>
                      <strong> Number of Nodes Around Central Node </strong>
                      <div class="numberOfNodes">
                        <div class="btn-group">
                        <!-- <button class="btn numberNodes" style="background-color:green" onclick="changeNumNodes(1)">1</button> -->
                        <button class="btn numberNodes" id="num1" onclick="changeNumNodes(1)">1</button>
                        <button class="btn numberNodes" id="num2" onclick="changeNumNodes(2)">2</button>
                        <button class="btn numberNodes" id="num3" onclick="changeNumNodes(3)">3</button>
                        <button class="btn numberNodes" id="num4" onclick="changeNumNodes(4)">4</button>
                        <button class="btn numberNodes" id="num5" onclick="changeNumNodes(5)">5</button>
                      </div>
                      <div class="btn-group">
                        <button class="btn numberNodes" id="num6" onclick="changeNumNodes(6)">6</button>
                        <button class="btn numberNodes" id="num7" onclick="changeNumNodes(7)">7</button>
                        <button class="btn numberNodes" id="num8" onclick="changeNumNodes(8)">8</button>
                        <button class="btn numberNodes" id="num9" onclick="changeNumNodes(9)">9</button>
                        <button class="btn numberNodes" id="num10" onclick="changeNumNodes(10)">10</button>
                      </div>
                      <div>
                  </li>
                  <li>
                      <strong> Degree of Nodes </strong>
                      <div class="btn-group degreeOfNodes">
                        <button class="btn degreeNodes" id="deg1" onclick="changeDegreeNodes(1)">1</button>
                        <button class="btn degreeNodes" id="deg2" onclick="changeDegreeNodes(2)">2</button>
                        <button class="btn degreeNodes" id="deg3" onclick="changeDegreeNodes(3)">3</button>
                        <button class="btn degreeNodes" id="deg4" onclick="changeDegreeNodes(4)">4</button>
                        <button class="btn degreeNodes" id="deg5" onclick="changeDegreeNodes(5)">5</button>
                      </div>
                  </li>
                  <li>
                      <strong> Size of Nodes </strong>
                      <div class="btn-group sizeOfNodes">
                        <button class="btn sizeNodes" id="size1" onclick="changeNodeSize(1)">Small</button>
                        <button class="btn sizeNodes" id="size17" onclick="changeNodeSize(17)">Medium</button>
                        <button class="btn sizeNodes" id="size30" onclick="changeNodeSize(30)">Large</button>
                      </div>
                  </li>
                  <li>
                      <strong> Freeze visualization? (It helps with lag)</strong> 
                      <div class="btn-group freezeTheNodes">
                        <button class="btn frozenOrNo" id="yeah" onclick="stopForceLayout()">Yes</button>
                        <button class="btn frozenOrNo" id="nope" onclick="restartForceLayout()">Unfreeze</button>
                      </div>
                  </li>
                  <li>
                      <strong> Charge (Space between nodes)</strong> 
                      <div class="btn-group chargeOfNodes">
                        <button class="btn chargeNodes" id="charge-1000" onclick="changeCharge(-1000)">Low</button>
                        <button class="btn chargeNodes" id="charge-5000" onclick="changeCharge(-5000)">Normal</button>
                        <button class="btn chargeNodes" id="charge-10000" onclick="changeCharge(-10000)">High</button>
                        <button class="btn chargeNodes" id="charge-50000" onclick="changeCharge(-50000)">Super</button>
                      </div>
                      <br>
                  </li>
                  <br>
              </ul>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->
      </div>

        <div class="header">
          <span style="font-size: 30px">7 degrees of <text id="primary">Spotify</text></span> <br>

          <span style="font-size: 20px"><text id="hovered"></text></span> <br>
          <a class="btn btn-default" id="menu-toggle">
            <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
          </a>
          <button type="button" class="btn btn-default" onclick="stopMusic()">
            <span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
          </button>
          <button type="button" class="btn btn-default" onclick="playPauseMusic()">
             <span class="glyphicon glyphicon-pause" aria-hidden="true"></span>
             <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
          </button>
          <button type="button" class="btn btn-default" onclick="whenClick(listenObj)">
            <span class="glyphicon glyphicon-forward" aria-hidden="true"></span>
          </button>
          <button type="button" class="btn btn-default" onclick="playNextArtist()">
            <span class="glyphicon glyphicon-step-forward" aria-hidden="true"></span>
          </button>
          <a class="btn btn-default" id="menu-toggle-right">
            <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
          </a>
        </div>

      <div id="main"></div>
      Comparative Popularity of Artists
      <div><svg id="chart"></svg></div>

  <script>
  var degree; // degree of separation where 0 is the original artist
  var limit = 4; // highest degree from main artist; max 5
  var frontier = [[],[]]; // keeping what needs to be visited (IDs)
  var visited = []; // keeping what has already been visited (IDs)
  var graph = {nodes: [], links: []};
  var starting_id = "04gDigrS5kc9YWfZHwBETP"; // maroon 5
  var num_related = 3; // number [1,20]
  var baseUrl = "https://api.spotify.com/v1/artists/";
  var searchUrl = "https://api.spotify.com/v1/search?q=";
  var audio = new Audio();
  var curr_id = null;
  var deg_names = ["zero","one","two","three","four","five"];
  var nodeSize = 17; // default size of nodes
  var currentNodeID = starting_id;
  var doubleClicked = false;
  var forceCharge = -5000;
  var currTracks = []; // current tracks of clicked artist
  var click_id = null;
  var click = 0; // for shuffling purposes
  var order = []; // for shuffling purposes
  var primaryObj = {}; 
  var listenObj = {}; // obj of artist currently listening to
  var samePrimary = false; // if executing an action results in same primary artist
  var click_deg = "zero"; // what degree node was clicked
  var deg_colors = ["#33B5E5","#FF4500","#98df8a","#FFBB33","#FF4444","#7E48E5"]
  var playing = true; // whether or not a song is playing
  var first_deg = []; // stores first degree artists as objs

  // Dimensions for SVG
  var margin = {top: 40, bottom: 10, left: 20, right: 20};
  var width = 1400 - margin.left - margin.right;
  var height = 550 - margin.top - margin.bottom;

  var force = d3.layout.force()
        .charge(forceCharge)
        .friction(0.9)
        .size([width, height])
        .gravity(2.0);

  // Creates sources <svg> element and inner g (for margins)
  var svg = d3.select("#main").append("svg")
            .attr("width", width+margin.left+margin.right)
            .attr("height", height+margin.top+margin.bottom)

  // first run: grabbing THE artist
  var start = function (id) {
    queue()
        .defer(d3.json, "https://api.spotify.com/v1/artists/" + id) 
        .await(function(error, data) {
          data.degree = 0;
          graph.nodes.push(data);
          frontier[0].push(id);
          visited.push(id);
          degree = 0;
          primaryObj = data;
          barRender();
          first_deg = [];
          get_related ();
        });
  }

  var get_related = function () {
    if (degree < limit) {
      var q = queue();

      frontier[0].forEach(function (id) {
          // load all artists that need to be visited
          q.defer(d3.json, "https://api.spotify.com/v1/artists/" + id + "/related-artists")
      }) 

      // does not run until all artists in frontier[0] have been loaded
      q.awaitAll(function (error, obj_array) { 
            
            if (error) return console.warn(error);

            obj_array.forEach(function (artist,i) {

              for (var j = 0; j < num_related; j++) {
                var rel_artist = artist.artists[j];

                if ( $.inArray(rel_artist.id, visited) < 0 ) {
                  rel_artist.degree = degree + 1;
                  graph.nodes.push(rel_artist); // add to nodes
                  frontier[1].push(rel_artist.id); // add to frontier
                  visited.push(rel_artist.id); // add to visited
                }

                // record first-degree artists
                if (degree == 0)
                  first_deg.push(rel_artist);

                getLinks(frontier[0][i],rel_artist.id);
              } // end for loop
            }) // end obj_array forEach

            frontier.shift(); // truncates frontiers such that frontiers[1] = frontiers[0]
            frontier.push([]); // pushes empty array to end of frontier
            degree = degree + 1;
            get_related ();
        }) // end awaitall

    } // end if (degree < limit)

    if (degree == limit) {
      d3.select(".header").select("#primary")
          .text(graph.nodes[0].name);
       
       render();
    }      
  } // end get_related

    // creates nodes and links
    var render = function () {
        var link = svg.selectAll(".link")
            .data(graph.links);

        link
          .enter().append("line");

        link
           .attr("class", "link");

        link
          .exit()
          .remove();

        var artist = svg.selectAll(".artist")
          .data(graph.nodes);

        var artist_enter = artist.enter()
                              .append("g")
                              .append("circle")

        var artist_names = artist
                        .append("text")
                        .attr("font-size", 14)
                        .text(function(d) { if (d.degree < 3) { return d.name} })

        artist
          .attr("class",function(d) {return "artist " + d.name})
        
        artist.select("circle")
          .attr("class", function (d) {return "node " + deg_names[d.degree]})
          .attr("id", function(d) {return d.name})
          .attr("r", function(d) {return nodeSize/(d.degree + 0.35)})

          artist
            .exit()
            .remove();

        var node = svg.selectAll(".node")
          .call(force.drag);

        force
          .nodes(graph.nodes)
          .links(graph.links)
          .start();

      force.on("tick", function(e) {
        link
          .attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

        node
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });

        svg.selectAll("text")
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; }); 
      })

      if (!samePrimary) {
        queue()
          .defer(d3.json, baseUrl + primaryObj.id + "/top-tracks?country=US") 
          .await(function(error, d) {
            playRandom(primaryObj,d);
        })
        listenObj = primaryObj;
        barSetup();
      }

      // hover
      d3.selectAll(".node").on("mouseover", function (obj) {
        var info = d3.select(".info")
        d3.select(".header").select("#hovered")
          .text("Next, let's listen to music by " + obj.name + ".");
      })

      d3.selectAll(".node").on("mouseout", function (obj) {
        var info = d3.select(".info");
        d3.select(".header").select("#hovered")
            .text("");
      })

      // click
      d3.selectAll(".node").on("click", function (obj) {
        click_deg = this.className.baseVal.split(" ")[1];
        whenClick(obj);
      });

      // double click
      d3.selectAll(".node").on("dblclick", function (obj) {
        click_deg = "zero";
        whenDblClick(obj);
      })
    } // end render

    // highlighting initial settings upon page load
    d3.select(".numberOfNodes").select("#num3")
        .classed("selected", true);
    d3.select(".degreeOfNodes").select("#deg4")
        .classed("selected", true);
    d3.select(".sizeOfNodes").select("#size17")
        .classed("selected", true);
    d3.select(".chargeOfNodes").select("#charge-5000")
        .classed("selected", true);

  if (window.location.hash) {
    startSearchHash();
  }
  else {
    start (starting_id);
  }

  </script>

    <!-- Menu Toggle Script for Sidebar -->
    <script>
      $("#menu-toggle").click(function(e) {
          e.preventDefault();
          $("#wrapper").toggleClass("toggled");
      });

    $(function() {
      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') 
          && location.hostname == this.hostname) {
            var target = $(this.hash);
            target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
            if (target.length) {
              $('html,body').animate({
                scrollTop: target.offset().top
              }, 1000);
              return false;
            }
        }
      });
    });

    </script>

    <!-- Toggle Script for Right Sidebar -->
    <script>
      $("#menu-toggle-right").click(function(e) {
          e.preventDefault();
          $("#wrapper-right").toggleClass("toggled");
      });

        $(function() {
      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({
              scrollTop: target.offset().top
            }, 1000);
            return false;
          }
        }
      });
    });

    </script>

</body>

</html>