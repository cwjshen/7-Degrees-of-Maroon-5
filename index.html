<!--- Last updated: Sunday, May 3 at 9:50 PM -->

<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Let's Go Team</title>

  <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>

    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>

    <!-- Sidebar -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <link href="css/simple-sidebar-right.css" rel="stylesheet">

    <!--Autosuggest jQuery-->
    <script src="libs/jquery-ui/jquery.js"></script>
    <script src="libs/jquery-ui/jquery-ui.js"></script>
    <link rel="stylesheet" href="libs/jquery-ui/jquery-ui.css">

    <style type="text/css">
    body {
      width: 1200px;
      margin: 25px auto;
      font-family: 'Lato', sans-serif;
      text-align: center;
    }
    .node {
      stroke: #999;
      stroke-width: 1;
      fill: #33B5E5;
      opacity: 0.9;
    }
    .zero {
      fill: #33B5E5;
    }
    .one{
      fill: #AA66CC; 
    }
    .two{
      fill: #99CC00;
    }
    .three{
      fill: #FFBB33;
    }
    .four{
      fill: #FF4444;
    }
      circle:hover {
          opacity: 0.3;
        }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    .info {
      line-height: 12px;
    }
    #clicked {
      font-size: 14pt;
    }
    .header {
      font-size: 18pt;
    }
    #primary {
      color: #33B5E5;
    }
    .playing {
      color: #FF4444;
    }
    .search{
      font-size: 16pt;
      text-align: center;
    }
    .ui-menu-item{
      font-family: 'Lato', sans-serif;
    }
  </style>

  <script>

  </script>
</head>

<body>
  <!-- Sidebar -->
        <div id="sidebar-wrapper" style="text-align: center">

          <div>
              <ul class="sidebar-nav">
                  <li class="sidebar-brand">
                      <strong>SEVEN DEGREES OF SPOTIFY</strong>
                  </li>
              </ul>
            </div>
            <!-- Navigation for the sidebar -->
            <div class="info">
              <ul class="sidebar-nav">
                  <li>
                      <text id="clicked">NONE</text></a>
                  </li>
                  <li>
                      <text class="song" id="song1">Artist Song 1</text>
                  </li>
                  <li>
                      <text class="song" id="song2">Artist Song 2</text>
                  </li>
                  <li>
                      <text class="song" id="song3">Artist Song 3</text>
                  </li>
                  <li>
                      <text class="song" id="song4">Artist Song 4</text>
                  </li>
                  <li>
                      <text class="song" id="song5">Artist Song 5</text>
                  </li>
                  <li>
                      <text class="song" id="song6">Artist Song 6</text>
                  </li>
                  <li>
                      <text class="song" id="song7">Artist Song 7</text>
                  </li>
                  <li>
                      <text class="song" id="song8">Artist Song 8</text>
                  </li>
                  <li>
                      <text class="song" id="song9">Artist Song 9</text>
                  </li>
                  <li>
                      <text class="song" id="song10">Artist Song 10</text>
                  </li>
                  <br> <br>
                  <span style="font-size: 20px"> JUMP HISTORY </span>
                  <br><br>
                  <li>
                      <a href="#big3">History 1</a>
                  </li>
                  <li>
                      <a href="#news">History 2</a>
                  </li>
                  <li>
                      <a href="#business">History 3</a>
                  </li>
              </ul>
            </div>  
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Sidebar -->
        <div id="sidebar-wrapper-right" style="text-align: center">
            <div>
              <ul class="sidebar-nav">
                  <li class="sidebar-brand">
                      <strong>USER CONTROL PANEL</strong>
                  </li>
              </ul>
            </div>

            <!-- Navigation for the sidebar -->
            <div>
              <ul class="sidebar-nav">
                  <div>
                      <input id="searchbar" class="search" placeholder="Search for an Artist" onkeyup="search()">
                      <button type="button" id="searchbutton" class="btn btn-default" onclick="goSearch()">GO</button>
                  </div>
                  <br>
                  <li>
                      <a><strong>NODE TOGGLES</strong></a>
                  </li>
                  Here, you can manipulate the properties surrounding the nodes.
                  <li>
                      <strong> Number of Nodes Around Central Node </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNumNodes(1)">1</button>
                        <button class="btn" onclick="changeNumNodes(2)">2</button>
                        <button class="btn" onclick="changeNumNodes(3)">3</button>
                        <button class="btn" onclick="changeNumNodes(4)">4</button>
                        <button class="btn" onclick="changeNumNodes(5)">5</button>
                      </div>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNumNodes(6)">6</button>
                        <button class="btn" onclick="changeNumNodes(7)">7</button>
                        <button class="btn" onclick="changeNumNodes(8)">8</button>
                        <button class="btn" onclick="changeNumNodes(9)">9</button>
                        <button class="btn" onclick="changeNumNodes(10)">10</button>
                      </div>
                  </li>
                  <li>
                      <strong> Degree of Nodes </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeDegreeNodes(1)">1</button>
                        <button class="btn" onclick="changeDegreeNodes(2)">2</button>
                        <button class="btn" onclick="changeDegreeNodes(3)">3</button>
                        <button class="btn" onclick="changeDegreeNodes(4)">4</button>
                        <button class="btn" onclick="changeDegreeNodes(5)">5</button>
                      </div>
                  </li>
                  <li>
                      <strong> Size of Nodes </strong>
                      <div class="btn-group">
                        <button class="btn" onclick="changeNodeSize(1)">Small</button>
                        <button class="btn" onclick="changeNodeSize(17)">Medium</button>
                        <button class="btn" onclick="changeNodeSize(30)">Large</button>
                      </div>
                  </li>
                  <li>
                      <strong> Freeze visualization? (It helps with lag)</strong> 
                      <div class="btn-group">
                        <button class="btn" onclick="stopForceLayout()">Yes</button>
                        <button class="btn" onclick="restartForceLayout()">Unfreeze</button>
                      </div>
                  </li>
                  <li>
                      <strong> Popularity Sort? (Implement this?)</strong> 
                      <div class="btn-group">
                        <button class="btn" onclick=";">Yes</button>
                        <button class="btn" onclick=";">No</button>
                      </div>
                      <br>
                      Something that changes value of friction?
                  </li>
                  <br>
                  <!-- <li>
                      <a href="#top"><strong>SOME SORT OF BARCHART</strong></a>
                  </li>
                  <li>
                      <a>Perhaps we can make a barchart ranking each of the artists based on popularity?</a>
                  </li> -->
              </ul>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <div class="header">
          7 degrees of <text id="primary">Spotify</text> <br>
          Hover: <text id="hovered"></text> <br>
          <button type="button" class="btn btn-default" onclick="stopMusic()">Stop Music</button>
        </div>

  <script>
  var degree; // degree of separation where 0 is the original artist
  var limit = 1; // highest degree from main artist; max 5
  var frontier = [[],[]]; // keeping what needs to be visited (IDs)
  var visited = []; // keeping what has already been visited (IDs)
  var graph = {nodes: [], links: []};
  var starting_id = "04gDigrS5kc9YWfZHwBETP";
  var num_related = 10; // number [1,20]
  var baseUrl = "https://api.spotify.com/v1/artists/";
  var searchUrl = "https://api.spotify.com/v1/search?q=";
  var audio = new Audio();
  var curr_id = null;
  var deg_names = ["zero","one","two","three","four","five"];
  var nodeSize = 17;
  var currentNodeID = starting_id;
  var doubleClicked = false;

  // Dimensions for SVG
  var margin = {top: 40, bottom: 10, left: 20, right: 20};
  var width = 1000 - margin.left - margin.right;
  var height = 600 - margin.top - margin.bottom;

  var force = d3.layout.force()
        .charge(-5000)
        .friction(0.1)
        .size([width, height]);


  // Creates sources <svg> element and inner g (for margins)
  var svg = d3.select("body").append("svg")
            .attr("width", width+margin.left+margin.right)
            .attr("height", height+margin.top+margin.bottom)

  // first run: grabbing THE artist
  var start = function (id) {
    queue()
        .defer(d3.json, "https://api.spotify.com/v1/artists/" + id) 
        .await(function(error, data) {
          data.degree = 0;
          graph.nodes.push(data);
          frontier[0].push(id);
          visited.push(id);
          degree = 0;
           
          get_related ();
        });
  }

  var get_related = function () {
    if (degree < limit) {
      var q = queue();
      
      frontier[0].forEach(function (id) {
          q.defer(d3.json, "https://api.spotify.com/v1/artists/" + id + "/related-artists")
      }) // load all artists that need to be visited

      // does not run until all artists in frontier[0] have been loaded
      q.awaitAll(function (error, obj_array) { 
            
            if (error) return console.warn(error);

            obj_array.forEach(function (artist,i) {

              for (var j = 0; j < num_related; j++)
              {
                var rel_artist = artist.artists[j];

                if ( $.inArray(rel_artist.id, visited) < 0 ) {
                  rel_artist.degree = degree + 1;
                  graph.nodes.push(rel_artist); // add to nodes
                  frontier[1].push(rel_artist.id); // add to frontier
                  visited.push(rel_artist.id); // add to visited
                }

                getLinks(frontier[0][i],rel_artist.id);
                
              }
                
            }) // end obj_array forEach

            frontier.shift(); // truncates frontiers such that frontiers[1] = frontiers[0]
            frontier.push([]); // pushes empty array to end of frontier
            degree = degree + 1;
            get_related ();

        }) // end awaitall

    } // end if (degree < limit)

    if (degree == limit){
      d3.select(".header").select("#primary")
          .text(graph.nodes[0].name);
       
       render ();
    }      
    } // end get_related

    // creates nodes and links
    var render = function () {
        var link = svg.selectAll(".link")
            .data(graph.links);

        link
          .enter().append("line");

        link
           .attr("class", "link");

        link
          .exit()
          .remove();

        var artist = svg.selectAll(".artist")
          .data(graph.nodes);

        var artist_enter = artist.enter()
                              .append("g")
                              .append("circle")

        var artist_names = artist
                        .append("text")
                        .attr("font-size", 14)
                        .text(function(d) { if (d.degree < 3) { return d.name} })

        artist
          .attr("class",function(d) {return "artist " + d.name})
        
        artist.select("circle")
          .attr("class", function (d) {return "node " + deg_names[d.degree]})
          .attr("id", function(d) {return d.name})
          .attr("r", function(d) {return nodeSize/(d.degree + 0.35)})

          artist
            .exit()
            .remove();

        var node = svg.selectAll(".node")
        .call(force.drag);

        force
        .nodes(graph.nodes)
        .links(graph.links)
        .start();

      force.on("tick", function(e) {
        link
        // .transition().duration(150)
        .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

          node
          // .transition().duration(150)
          .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

          svg.selectAll("text")
            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; }); 
      })

      // hover
      d3.selectAll(".node").on("mouseover", function (obj) {
        var info = d3.select(".info")
        d3.select(".header").select("#hovered")
          .text(obj.name.toUpperCase());
        info.select("#degree")
          .text(obj.degree);
      })

      d3.selectAll(".node").on("mouseout", function (obj) {
        var info = d3.select(".info");
        d3.select(".header").select("#hovered")
            .text("NONE");
        info.select("#degree")
            .text("None");
      })

      // click
      d3.selectAll(".node").on("click", function (obj) {
        d3.select(".info").selectAll(".song")
            .classed("playing",false);

        d3.select(".info").select("#clicked")
          .text(obj.name);

        var track_num = Math.floor((Math.random() * 10));

          queue()
            .defer(d3.json, baseUrl + obj.id + "/top-tracks?country=US") 
            .await(function(error, d) {
              getSongs(d);

              curr_id = obj.id;
              var track = d.tracks[track_num];
              d3.select(".info").select("#song" + (track_num+1))
                .classed("playing",true);
              audio.src = track.preview_url;
              audio.play();
          })
      });

      // click
      d3.selectAll(".node").on("dblclick", function (obj) {
        doubleClicked = true;
        currentNodeID = obj.id;
        refresh(obj.id);
      })

    }


/*************************************************************

  HELPER FUNCTIONS GO BELOW HERE...

  ***********************************************************/

  // function pushes the corresponding link into graph.links
  var getLinks = function (sourceID, targetID) {

    // variable to store index in graph.nodes of the artist we only have the ID for
    var sourceIndex;
    var targetIndex;

    for (var j = graph.nodes.length - 1; j >= 0; j--) {
            if (graph.nodes[j].id == sourceID)
              sourceIndex = j;
            if (graph.nodes[j].id == targetID)
              targetIndex = j;
    };
    
    graph.links.push({source: sourceIndex, target: targetIndex});
  }

  // function that populates songs
  var getSongs = function (obj) {
    obj.tracks.forEach(function(track,i){
      d3.select(".info").select("#song" + (i+1))
        .text(track.name);
    })    
  }

  // stops music
  var stopMusic = function() {
    d3.select(".info").selectAll(".song")
      .classed("playing",false);
    audio.pause();
    audio.currentTime = 0;
    curr_id = null;
  }

  var search = function () {
    var searched = document.getElementById("searchbar").value;
    var artistPool = [];
    queue()
      .defer(d3.json, searchUrl + searched + "&type=artist")
      .await(function (error, data) {
        data.artists.items.forEach(function (item, i) {
          artistPool.push(item.name);
          $( "#searchbar" ).autocomplete({
            source: artistPool
          });            
        });
      })   
  }



  var refresh = function (id) {
    graph = {nodes: [], links: []};
    frontier = [[],[]]; // keeping what needs to be visited (IDs)
    visited = [];
    svg.selectAll("text").remove();
    start(id);

  }

  var goSearch = function () {
    var searched = document.getElementById("searchbar").value;
    queue()
      .defer(d3.json, searchUrl + searched + "&type=artist")
      .await(function (error, data) {
        curr_id = data.artists.items[0].id;
        console.log(data)
        console.log(data.artists.items[0].name + data.artists.items[0].id)        
        refresh(curr_id);
      })
  }

  var changeNumNodes = function(number) {
    num_related = number;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  // Note to self: the degree that I'm thinking of is actually limit
  var changeDegreeNodes = function(newDegree) {
    limit = newDegree;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  var changeNodeSize = function(sizeOfNode) {
    nodeSize = sizeOfNode;
    if (doubleClicked == true) {
      refresh(currentNodeID);
    }
    else if (curr_id == null) {
      refresh(starting_id);
    }
    else {
      refresh(curr_id);
    }
  }

  var stopForceLayout = function() {
    force.stop();
  }

  var restartForceLayout = function() {
    force.start();
  }

  start (starting_id);

  </script>

</body>

</html>